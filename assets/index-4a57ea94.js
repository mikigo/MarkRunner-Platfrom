var $=(L,o,p)=>new Promise((g,c)=>{var S=m=>{try{h(p.next(m))}catch(r){c(r)}},N=m=>{try{h(p.throw(m))}catch(r){c(r)}},h=m=>m.done?g(m.value):Promise.resolve(m.value).then(S,N);h((p=p.apply(L,o)).next())});import{bo as H,z as U,af as J,Z as v,S as X,o as y,b,w as i,e as s,f as a,bp as Y,d as V,H as w,X as k,Y as Q,ac as B,ag as W,aL as F,$ as ee,J as ae,aK as le,bq as te,h as d,aM as I,aN as se,ah as x,a as re}from"./index-522183a4.js";import{_ as ie}from"./CommonPage-29255bb8.js";import{_ as A}from"./QueryBarItem-cab8910f.js";import{u as ue,_ as ne,N as R}from"./useCRUD-3bf9183c.js";import{_ as de,a as oe,h as pe,i as me,j as ve}from"./TheIcon-e53917d6.js";import{N as _}from"./Input-9701dcf4.js";import{N as fe,a as f}from"./FormItem-065ce0d6.js";import{N as q}from"./Switch-d398be6e.js";import{N as ge}from"./TreeSelect-5483c2be.js";import{_ as ce}from"./Tree-61fa7ff3.js";import"./AppPage-aa79a119.js";const ye=H(!0),qe=Object.assign({name:"用户管理"},{__name:"index",setup(L){const o=U(null),p=U({}),g=J("permission"),{modalVisible:c,modalTitle:S,modalAction:N,modalLoading:h,handleSave:m,modalForm:r,modalFormRef:T,handleEdit:K,handleDelete:Z,handleAdd:E}=ue({name:"用户",initForm:{},doCreate:v.createUser,doUpdate:v.updateUser,doDelete:v.deleteUser,refresh:()=>{var l;return(l=o.value)==null?void 0:l.handleSearch()}}),P=U([]),C=U([]);X(()=>{var l;(l=o.value)==null||l.handleSearch(),v.getRoleList({page:1,page_size:9999}).then(e=>P.value=e.data),v.getDepts().then(e=>C.value=e.data)});const O=[{title:"名称",key:"username",width:60,align:"center",ellipsis:{tooltip:!0}},{title:"邮箱",key:"email",width:60,align:"center",ellipsis:{tooltip:!0}},{title:"用户角色",key:"role",width:60,align:"center",render(l){var t;const e=(t=l.roles)!=null?t:[],u=[];for(let n=0;n<e.length;n++)u.push(d(I,{type:"info",style:{margin:"2px 3px"}},{default:()=>e[n].name}));return d("span",u)}},{title:"部门",key:"dept.name",align:"center",width:40,ellipsis:{tooltip:!0}},{title:"超级用户",key:"is_superuser",align:"center",width:40,render(l){return d(I,{type:"info",style:{margin:"2px 3px"}},{default:()=>l.is_superuser?"是":"否"})}},{title:"上次登录时间",key:"last_login",align:"center",width:80,ellipsis:{tooltip:!0},render(l){return d(k,{size:"small",type:"text",ghost:!0},{default:()=>l.last_login!==null?se(l.last_login):null,icon:x("mdi:update",{size:16})})}},{title:"禁用",key:"is_active",width:50,align:"center",render(l){return d(q,{size:"small",rubberBand:!1,value:l.is_active,loading:!!l.publishing,checkedValue:!1,uncheckedValue:!0,onUpdateValue:()=>j(l)})}},{title:"操作",key:"actions",width:80,align:"center",fixed:"right",render(l){return[w(d(k,{size:"small",type:"primary",style:"margin-right: 8px;",onClick:()=>{var e;K(l),r.value.dept_id=(e=l.dept)==null?void 0:e.id,r.value.role_ids=l.roles.map(u=>u=u.id),delete r.value.dept}},{default:()=>"编辑",icon:x("material-symbols:edit",{size:16})}),[[g,"post/api/v1/user/update"]]),d(R,{onPositiveClick:()=>Z({user_id:l.id},!1),onNegativeClick:()=>{}},{trigger:()=>w(d(k,{size:"small",type:"error",style:"margin-right: 8px;"},{default:()=>"删除",icon:x("material-symbols:delete-outline",{size:16})}),[[g,"delete/api/v1/user/delete"]]),default:()=>d("div",{},"确定删除该用户吗?")}),!l.is_superuser&&d(R,{onPositiveClick:()=>$(this,null,function*(){var e;try{yield v.resetPassword({user_id:l.id}),$message.success("密码已成功重置为123456"),yield(e=o.value)==null?void 0:e.handleSearch()}catch(u){$message.error("重置密码失败: "+u.message)}}),onNegativeClick:()=>{}},{trigger:()=>w(d(k,{size:"small",type:"warning",style:"margin-right: 8px;"},{default:()=>"重置密码",icon:x("material-symbols:lock-reset",{size:16})}),[[g,"post/api/v1/user/reset_password"]]),default:()=>d("div",{},"确定重置用户密码为123456吗?")})]}}];function j(l){return $(this,null,function*(){var t,n;if(!l.id)return;if(re().userId===l.id){$message.error("当前登录用户不可禁用！");return}l.publishing=!0,l.is_active=l.is_active===!1,l.publishing=!1;const u=[];l.roles.forEach(D=>{u.push(D.id)}),l.role_ids=u,l.dept_id=(t=l.dept)==null?void 0:t.id;try{yield v.updateUser(l),$message==null||$message.success(l.is_active?"已取消禁用该用户":"已禁用该用户"),(n=o.value)==null||n.handleSearch()}catch(D){l.is_active=l.is_active===!1}finally{l.publishing=!1}})}let z=null;const M=({option:l})=>({onClick(){var e;z===l.id?((e=o.value)==null||e.handleSearch(),z=null):v.getUserList({dept_id:l.id}).then(u=>{o.value.tableData=u.data,z=l.id})}}),G={username:[{required:!0,message:"请输入名称",trigger:["input","blur"]}],email:[{required:!0,message:"请输入邮箱地址",trigger:["input","change"]},{trigger:["blur"],validator:(l,e,u)=>{if(!/^[a-zA-Z0-9_-]+@[a-zA-Z0-9_-]+(\.[a-zA-Z0-9_-]+)+$/.test(r.value.email)){u("邮箱格式错误");return}u()}}],password:[{required:!0,message:"请输入密码",trigger:["input","blur","change"]}],confirmPassword:[{required:!0,message:"请再次输入密码",trigger:["input"]},{trigger:["blur"],validator:(l,e,u)=>{if(e!==r.value.password){u("两次密码输入不一致");return}u()}}],roles:[{type:"array",required:!0,message:"请至少选择一个角色",trigger:["blur","change"]}]};return(l,e)=>{const u=ce;return y(),b(a(te),{"has-sider":"","wh-full":""},{default:i(()=>[s(a(Y),{bordered:"","content-style":"padding: 24px;","collapsed-width":0,width:240,"show-trigger":"arrow-circle"},{default:i(()=>[e[14]||(e[14]=V("h1",null,"部门列表",-1)),e[15]||(e[15]=V("br",null,null,-1)),s(u,{"block-line":"",data:C.value,"key-field":"id","label-field":"name","default-expand-all":"","node-props":M},null,8,["data"])]),_:1,__:[14,15]}),s(a(ye),null,{default:i(()=>[s(ie,{"show-footer":"",title:"用户列表"},{action:i(()=>[w((y(),b(a(k),{type:"primary",onClick:a(E)},{default:i(()=>[s(de,{icon:"material-symbols:add",size:18,class:"mr-5"}),e[16]||(e[16]=Q("新建用户 ",-1))]),_:1,__:[16]},8,["onClick"])),[[a(g),"post/api/v1/user/create"]])]),default:i(()=>[s(oe,{ref_key:"$table",ref:o,"query-items":p.value,"onUpdate:queryItems":e[4]||(e[4]=t=>p.value=t),columns:O,"get-data":a(v).getUserList},{queryBar:i(()=>[s(A,{label:"名称","label-width":40},{default:i(()=>[s(a(_),{value:p.value.username,"onUpdate:value":e[0]||(e[0]=t=>p.value.username=t),clearable:"",type:"text",placeholder:"请输入用户名称",onKeypress:e[1]||(e[1]=B(t=>{var n;return(n=o.value)==null?void 0:n.handleSearch()},["enter"]))},null,8,["value"])]),_:1}),s(A,{label:"邮箱","label-width":40},{default:i(()=>[s(a(_),{value:p.value.email,"onUpdate:value":e[2]||(e[2]=t=>p.value.email=t),clearable:"",type:"text",placeholder:"请输入邮箱",onKeypress:e[3]||(e[3]=B(t=>{var n;return(n=o.value)==null?void 0:n.handleSearch()},["enter"]))},null,8,["value"])]),_:1})]),_:1},8,["query-items","get-data"]),s(ne,{visible:a(c),"onUpdate:visible":e[13]||(e[13]=t=>W(c)?c.value=t:null),title:a(S),loading:a(h),onSave:a(m)},{default:i(()=>[s(a(fe),{ref_key:"modalFormRef",ref:T,"label-placement":"left","label-align":"left","label-width":80,model:a(r),rules:G},{default:i(()=>[s(a(f),{label:"用户名称",path:"username"},{default:i(()=>[s(a(_),{value:a(r).username,"onUpdate:value":e[5]||(e[5]=t=>a(r).username=t),clearable:"",placeholder:"请输入用户名称"},null,8,["value"])]),_:1}),s(a(f),{label:"邮箱",path:"email"},{default:i(()=>[s(a(_),{value:a(r).email,"onUpdate:value":e[6]||(e[6]=t=>a(r).email=t),clearable:"",placeholder:"请输入邮箱"},null,8,["value"])]),_:1}),a(N)==="add"?(y(),b(a(f),{key:0,label:"密码",path:"password"},{default:i(()=>[s(a(_),{value:a(r).password,"onUpdate:value":e[7]||(e[7]=t=>a(r).password=t),"show-password-on":"mousedown",type:"password",clearable:"",placeholder:"请输入密码"},null,8,["value"])]),_:1})):F("",!0),a(N)==="add"?(y(),b(a(f),{key:1,label:"确认密码",path:"confirmPassword"},{default:i(()=>[s(a(_),{value:a(r).confirmPassword,"onUpdate:value":e[8]||(e[8]=t=>a(r).confirmPassword=t),"show-password-on":"mousedown",type:"password",clearable:"",placeholder:"请确认密码"},null,8,["value"])]),_:1})):F("",!0),s(a(f),{label:"角色",path:"role_ids"},{default:i(()=>[s(a(pe),{value:a(r).role_ids,"onUpdate:value":e[9]||(e[9]=t=>a(r).role_ids=t)},{default:i(()=>[s(a(me),{"item-style":"display: flex;"},{default:i(()=>[(y(!0),ee(ae,null,le(P.value,t=>(y(),b(a(ve),{key:t.id,value:t.id,label:t.name},null,8,["value","label"]))),128))]),_:1})]),_:1},8,["value"])]),_:1}),s(a(f),{label:"超级用户",path:"is_superuser"},{default:i(()=>[s(a(q),{value:a(r).is_superuser,"onUpdate:value":e[10]||(e[10]=t=>a(r).is_superuser=t),size:"small","checked-value":!0,"unchecked-value":!1},null,8,["value"])]),_:1}),s(a(f),{label:"禁用",path:"is_active"},{default:i(()=>[s(a(q),{value:a(r).is_active,"onUpdate:value":e[11]||(e[11]=t=>a(r).is_active=t),"checked-value":!1,"unchecked-value":!0,"default-value":!0},null,8,["value"])]),_:1}),s(a(f),{label:"部门",path:"dept_id"},{default:i(()=>[s(a(ge),{value:a(r).dept_id,"onUpdate:value":e[12]||(e[12]=t=>a(r).dept_id=t),options:C.value,"key-field":"id","label-field":"name",placeholder:"请选择部门",clearable:"","default-expand-all":""},null,8,["value","options"])]),_:1})]),_:1},8,["model"])]),_:1},8,["visible","title","loading","onSave"])]),_:1})]),_:1})]),_:1})}}});export{qe as default};
